<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gallery – Dr. Kurniawan</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* ===== Gallery styles: mengikuti bahasa visual publications/programs ===== */
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 18px}
    .chip{padding:.45rem .7rem;border-radius:999px;background:#F2F5FF;border:1px solid #E3E8FF;cursor:pointer}
    .search{padding:.65rem .8rem;border:1px solid #E6E7F2;border-radius:12px;min-width:240px}

    .gal-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
    .gal-item{position:relative;border-radius:12px;overflow:hidden;box-shadow:var(--shadow);background:#000}
    /* Grid thumbnail wrapper keeps 16:9 so layout doesn't jump, but NOT in lightbox */
    .gal-item::before{content:"";display:block;aspect-ratio:16/9}
    .gal-item img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block}
    .gal-item .cap{position:absolute;inset:auto 0 0 0;padding:6px 10px;color:#fff;background:linear-gradient(180deg,rgba(0,0,0,0) 0%,rgba(0,0,0,.65) 100%);font-size:.9rem}

    .gal-item.video::after{content:"▶";position:absolute;inset:8px auto auto 8px;background:rgba(0,0,0,.6);color:#fff;border-radius:8px;padding:.15rem .4rem;font-weight:800}

    /* Lightbox dialog */
    .lightbox{border:none;background:rgba(0,0,0,.75);padding:0;width:100%;height:100%}
    .lb-wrap{position:relative;width:min(1100px,92vw);margin:6vh auto;background:#000;border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
    /* IMAGES in lightbox: natural ratio, no aspect-ratio forcing */
    .lightbox img:not([hidden]){
      display:block;width:100%;height:auto;border:0;
      max-height:calc(92vh - 48px);
      object-fit:contain;background:#000
    }
    /* VIDEO/IFRAME keep 16:9 */
    .lightbox iframe:not([hidden]), #lbVideo:not([hidden]){display:block;width:100%;aspect-ratio:16/9;border:0}
    .lb-close{position:absolute;top:8px;right:8px;z-index:2;border:none;background:rgba(255,255,255,.92);padding:.4rem .6rem;border-radius:10px;cursor:pointer}

    .meta-bar{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 12px;color:#C9D4FF;background:#0F102A}
    .meta-bar small{opacity:.85}

    .gal-grid {
  display: grid;
  gap: 16px;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* dari 180px → 280px */
  padding: 10px 0;
}

.gal-item {
  position: relative;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: var(--shadow);
  background: #000;
}

/* rasio diperbesar dikit, biar preview tidak gepeng */
.gal-item::before {
  content: "";
  display: block;
  aspect-ratio: 4 / 3; /* sebelumnya 16/9 */
}

.gal-item img {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.gal-item img {
  transition: transform .3s ease;
}
.gal-item:hover img {
  transform: scale(1.05);
}


  </style>

  <script>
function safeSrc(src) {
  if (!src) return '';
  src = String(src).trim();
  // Cloudinary
  if (/^https?:\/\/res\.cloudinary\.com\//i.test(src)) {
    return src.replace(/^http:/i, 'https:')
              .replace(/\/image\/upload\/(?!f_auto,q_auto\/)/, '/image/upload/f_auto,q_auto/');
  }
  // URL luar -> fetch via Cloudinary
  if (/^https?:\/\//i.test(src)) {
    return `https://res.cloudinary.com/dy7lzcjfb/image/fetch/f_auto,q_auto/${encodeURIComponent(src)}`;
  }
  // Path lokal -> absolut lalu fetch via Cloudinary (buat HEIC)
  const abs = src.startsWith('/') ? src : '/' + src.replace(/^\.?\//,'');
  const full = `${location.origin}${abs}`;
  return `https://res.cloudinary.com/dy7lzcjfb/image/fetch/f_auto,q_auto/${encodeURIComponent(full)}`;
}

function normalizeYouTube(y) {
  if (!y) return '';
  const s = String(y).trim();
  const m = s.match(/(?:youtu\.be\/|v=)([A-Za-z0-9_-]{6,})/);
  return m ? m[1] : s; // kalau user kasih URL, ambil ID-nya; kalau sudah ID, pakai apa adanya
}

// di dalam loop render item:
const ytId = normalizeYouTube(item.youtube);
if (ytId) {
  html = `
    <article class="g-item">
      <div class="yt">
        <iframe width="560" height="315"
          src="https://www.youtube.com/embed/${ytId}"
          title="YouTube video player" frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen></iframe>
      </div>
      <h4>${(item.title||'').replace(/</g,'&lt;')}</h4>
    </article>`;
} else {
  const src = safeSrc(item.src);
  const thumb = safeSrc(item.thumb || item.src);
  if ((item.type||'image') === 'video') {
    html = `
      <article class="g-item">
        <video controls preload="metadata" ${thumb ? `poster="${thumb}"` : ''}>
          <source src="${src}">
        </video>
        <h4>${(item.title||'').replace(/</g,'&lt;')}</h4>
      </article>`;
  } else {
    html = `
      <article class="g-item">
        <img loading="lazy" src="${src}" alt="${(item.title||'').replace(/"/g,'&quot;')}"
             onerror="this.onerror=null; this.src='/assets/uploads/placeholder.jpg'; console.warn('IMG fail:', this.currentSrc);" />
        <h4>${(item.title||'').replace(/</g,'&lt;')}</h4>
      </article>`;
  }
}
</script>

  
</head>
<body>
  <!-- NAV -->
  <nav class="nav">
    <div class="brand"><a href="index.html">Dr. Kurniawan</a></div>
    <button class="nav-toggle" aria-expanded="false" aria-label="Toggle menu">☰</button>
    <div class="nav-links">
      <a class="btn btn-ghost" href="index.html#about">About</a>
      <a class="btn btn-ghost" href="publications.html">Publications</a>
      <a class="btn btn-ghost" href="blog.html">Blog</a>
      <a class="btn btn-ghost" href="programs.html">Program</a>
      <a class="btn btn-ghost" href="gallery.html">Gallery</a>
      <a class="btn btn-accent" id="waTop" href="#">WhatsApp</a>
    </div>
  </nav>

  <!-- HERO -->
  <header class="hero">
    <svg class="skyline" viewBox="0 0 1200 140" preserveAspectRatio="none" aria-hidden="true">
      <path d="M0,120 L80,110 L120,118 L180,95 L220,95 L240,70 L260,95 L320,90 L360,94 L400,70 L430,70 L430,110 L470,105 L520,85 L560,100 L600,80 L640,95 L700,70 L740,70 L760,90 L820,92 L880,80 L930,95 L980,88 L1030,96 L1100,85 L1160,100 L1200,96 L1200,140 L0,140 Z" fill="#000" opacity=".35"/>
    </svg>
    <div class="inner">
      <h1 class="title">Gallery</h1>
      <p class="subtitle" style="color:#E8ECFF;max-width:760px">Dokumentasi kegiatan: seminar, workshop, keynote, dan kelas SpeakUp. Foto & video pilihan.</p>
    </div>
  </header>

  <main class="wrap">
    <!-- Controls -->
    <div class="filters">
      <input id="q" class="search" placeholder="Cari… (mis. seminar, korporat, sekolah)"/>
      <span class="chip" data-tag="all">Semua</span>
      <span class="chip" data-tag="seminar">Seminar</span>
      <span class="chip" data-tag="workshop">Workshop</span>
      <span class="chip" data-tag="keynote">Keynote</span>
      <span class="chip" data-tag="school">Sekolah/Komunitas</span>
      <span class="chip" data-tag="media">Media/TV</span>
      <span class="chip" data-tag="video">Video</span>
    </div>

    <!-- Grid -->
    <section>
      <div class="gal-grid" id="gal"></div>
    </section>
  </main>

  <!-- Lightbox dialog (image/video) -->
  <dialog id="lightbox" class="lightbox" aria-label="Preview media" tabindex="-1">
    <div class="lb-wrap">
      <button class="lb-close" aria-label="Close">✕</button>
      <img id="lbImg" alt="" hidden>
      <iframe id="lbVid" src="" title="YouTube" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen hidden></iframe>
      <video id="lbVideo" controls preload="metadata" hidden></video>
      <div class="meta-bar"><small id="lbMeta">&nbsp;</small><small id="lbCount">&nbsp;</small></div>
    </div>
  </dialog>

  <!-- FOOTER -->
  <footer>
    <div class="container" style="display:grid;gap:12px;grid-template-columns:1fr auto;align-items:center">
      <div>
        <div class="brand">Dr. Kurniawan</div>
        <small>© <span id="y"></span> SpeakUp Center • Gallery</small>
      </div>
      <div>
        <a class="btn btn-accent" id="waFoot" href="#">WhatsApp</a>
      </div>
    </div>
  </footer>

  <script>
  // ===== WhatsApp helper =====
  const WA_NUMBER = '6287812844395';
  const WA_BASE = `https://wa.me/${WA_NUMBER}`;
  const waHref = (text)=> `${WA_BASE}?text=${encodeURIComponent(text || 'Halo Dr. Kurniawan, saya ingin berdiskusi.')}`;
  document.getElementById('waTop').href = waHref('Halo, saya ingin berdiskusi.');
  document.getElementById('waFoot').href = waHref();
  document.getElementById('y').textContent = new Date().getFullYear();

  // ===== Helpers =====
  const isAbsolute = (u) => /^https?:\/\//i.test(u||'');
  const isYouTubeId = (s) => /^[\w-]{11}$/.test(s||'');
  const isYouTubeUrl = (s) => /(youtube\.com|youtu\.be)/i.test(s||'');

  // Robust YT embed (supports youtu.be, shorts, &t=)
  const toYouTubeEmbed = (idOrUrl)=>{
    try{
      if (isYouTubeId(idOrUrl)) {
        return `https://www.youtube.com/embed/${idOrUrl}`;
      }
      const u = new URL(idOrUrl);
      let id = u.searchParams.get('v');
      if (!id && /youtu\.be$/i.test(u.hostname)) {
        id = u.pathname.split('/').filter(Boolean).shift();
      }
      if (!id && /youtube\.com$/i.test(u.hostname)) {
        const parts = u.pathname.split('/').filter(Boolean);
        const iShorts = parts.indexOf('shorts');
        if (iShorts !== -1 && parts[iShorts+1]) id = parts[iShorts+1];
        if (!id && parts.includes('embed')) {
          id = parts.pop();
        }
      }
      const t = u.searchParams.get('t') || u.searchParams.get('start') || '';
      const start = t ? `?start=${parseInt(String(t).replace(/\D/g,''),10) || 0}` : '';
      return id ? `https://www.youtube.com/embed/${id}${start}` : '';
    }catch(_){ return ''; }
  };

  // ===== Cloudinary helpers =====
  function isCloudinary(url){
    try{ const u = new URL(url); return /(^|\.)res\.cloudinary\.com$/i.test(u.hostname); }catch{ return false; }
  }
  function cldInsertTransform(url, transform){
    try{
      const u = new URL(url);
      const parts = u.pathname.split('/').filter(Boolean);
      const ixUpload = parts.findIndex(p => p === 'upload');
      if (ixUpload === -1) return url;
      const before = parts.slice(0, ixUpload + 1);
      const after  = parts.slice(ixUpload + 1);
      const newPath = '/' + [...before, transform, ...after].join('/');
      u.pathname = newPath;
      return u.toString();
    }catch{ return url; }
  }
  function parseCloudinary(url){
    let kind = 'image';
    let poster = '';
    let thumb = '';
    let src = url;
    try{
      const u = new URL(url);
      const parts = u.pathname.split('/').filter(Boolean);
      const file = parts[parts.length-1] || '';
      const ext = (file.split('?')[0].split('#')[0].split('.').pop() || '').toLowerCase();
      const isVideoPath = parts[0] === 'video' || parts[0] === 'videos';
      const isImagePath = parts[0] === 'image' || parts[0] === 'images';
      if (isVideoPath) kind = 'video';
      else if (isImagePath) kind = 'image';
      if (['mp4','webm','ogv','m3u8'].includes(ext)) kind = 'video';
      if (['jpg','jpeg','png','webp','gif','avif','heic'].includes(ext)) kind = 'image';

      if (kind === 'image'){
        thumb = cldInsertTransform(url, 'c_fill,w_800,h_450,q_auto,f_auto');
        src   = cldInsertTransform(url, 'c_fit,w_2000,q_auto,f_auto');
      }else{
        poster = cldInsertTransform(url, 'so_1,f_jpg,vc_auto');
        src = url;
        thumb = cldInsertTransform(url, 'so_1,f_jpg,c_fill,w_800,h_450,q_auto');
      }
      return { kind, src, poster, thumb };
    }catch{
      return { kind, src, poster, thumb };
    }
  }
  const norm = (u)=> (isAbsolute(u||'')) ? u : (u||'');

  // ===== Navbar toggle =====
  const tog=document.querySelector('.nav-toggle');
  const links=document.querySelector('.nav-links');
  if(tog&&links){
    tog.addEventListener('click',(e)=>{e.stopPropagation();const open=links.classList.toggle('show');tog.setAttribute('aria-expanded',open?'true':'false');});
    document.addEventListener('click',(e)=>{const inside=links.contains(e.target)||tog.contains(e.target);if(!inside&&links.classList.contains('show')){links.classList.remove('show');tog.setAttribute('aria-expanded','false');}});
  }

  // ===== Filter + Search =====
  const filtersEl = document.querySelector('.filters');
  const q = document.getElementById('q');
  const lbCount = document.getElementById('lbCount');
  let active = 'all';
  const getItems = () => [...document.querySelectorAll('.gal-item')];
  function apply(){
    const items = getItems();
    const s = (q?.value || '').toLowerCase();
    let shown = 0;
    items.forEach(el=>{
      const tags  = (el.dataset.tags  || '').toLowerCase();
      const title = (el.dataset.title || '').toLowerCase();
      const okTag  = active==='all' || tags.includes(active);
      const okText = !s || title.includes(s) || tags.includes(s);
      const vis = okTag && okText;
      el.style.display = vis ? 'block' : 'none';
      if(vis) shown++;
    });
    if(lbCount) lbCount.textContent = shown ? `${shown} media` : 'Tidak ada hasil';
  }
  filtersEl?.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip');
    if(!chip) return;
    active = chip.dataset.tag || 'all';
    apply();
  });
  q?.addEventListener('input', apply);

  // ===== Lightbox =====
  const lb     = document.getElementById('lightbox');
  const lbImg  = document.getElementById('lbImg');
  const lbVid  = document.getElementById('lbVid');
  const lbVideo= document.getElementById('lbVideo');
  const lbMeta = document.getElementById('lbMeta');
  const lbClose= document.querySelector('.lb-close');
  const grid   = document.getElementById('gal');

  function guessMimeByExt(src){
    const ext = (src.split('?')[0].split('#')[0].split('.').pop() || '').toLowerCase();
    if (ext === 'mp4' || ext === 'm4v') return 'video/mp4';
    if (ext === 'webm') return 'video/webm';
    if (ext === 'ogv'  || ext === 'ogg') return 'video/ogg';
    if (ext === 'm3u8') return 'application/x-mpegURL';
    return 'video/mp4';
  }

  function openMedia(fig){
    const kind = fig.dataset.kind || (fig.classList.contains('video') ? 'video' : 'image');
    const src = fig.dataset.src || '';
    const poster = fig.dataset.poster || '';
    const title = fig.dataset.title || '';

    // reset
    lbImg.hidden = true;  lbImg.src = '';
    lbVid.hidden = true;  lbVid.src = '';
    lbVideo.hidden = true; lbVideo.innerHTML=''; lbVideo.removeAttribute('poster');

    if (kind === 'image'){
      lbImg.hidden = false;
      lbImg.src = src || (fig.querySelector('img')?.src || '');
      lbImg.alt = title;
    } else if (kind === 'youtube'){
      lbVid.hidden = false;
      lbVid.src = toYouTubeEmbed(src);
    } else {
      lbVideo.hidden = false;
      if (poster) lbVideo.setAttribute('poster', poster);
      const type = guessMimeByExt(src);
      lbVideo.innerHTML = `<source src="${src}" type="${type}">`;
      lbVideo.preload = 'metadata';
      lbVideo.playsInline = true;
      lbVideo.controls = true;
      lbVideo.load();
    }
    lbMeta.textContent = title;
    lb.showModal();
  }

  grid.addEventListener('click', (e)=>{
    const fig = e.target.closest('.gal-item');
    if(!fig) return;
    openMedia(fig);
    const visible = getItems().filter(el => el.style.display !== 'none');
    lb.dataset.idx = visible.indexOf(fig);
  });

  function showByIndex(i){
    const visible = getItems().filter(el => el.style.display !== 'none');
    if(!visible.length) return;
    const n = ((i % visible.length) + visible.length) % visible.length;
    const el = visible[n];
    openMedia(el);
    lb.dataset.idx = n;
  }

  lb.addEventListener('keydown',(e)=>{
    const idx = parseInt(lb.dataset.idx || '0', 10);
    if(e.key==='Escape')      lb.close();
    if(e.key==='ArrowRight')  showByIndex(idx+1);
    if(e.key==='ArrowLeft')   showByIndex(idx-1);
  });
  lbClose?.addEventListener('click',()=> lb.close());
  lb.addEventListener('click',(e)=>{ if(e.target===lb) lb.close(); });
  lb.addEventListener('close',()=>{ lbVid.src=''; lbVideo.pause?.(); lbVideo.removeAttribute('src'); lbVideo.innerHTML=''; });

  // ===== Build items from JSON (Cloudinary + YouTube + fallback) =====
  function buildItemFromSource(it){
    const fig = document.createElement('figure');
    fig.className = 'gal-item' + (it.type==='video' ? ' video' : '');
    fig.dataset.tags  = [it.category, ...(it.tags||[])].join(' ');
    fig.dataset.title = it.title || '';

    const img = document.createElement('img');
    img.loading = 'lazy'; img.decoding = 'async';

    const raw = norm(it.src);

    if (it.type === 'video'){
      // YouTube variants
      if (isYouTubeId(raw) || isYouTubeUrl(raw)){
        let thumbId = '';
        if (isYouTubeId(raw)) thumbId = raw;
        else {
          try {
            const u = new URL(raw);
            thumbId = u.searchParams.get('v') || (u.pathname.includes('/shorts/') ? u.pathname.split('/').pop() : raw.split('/').pop());
          } catch {
            thumbId = raw.split('/').pop();
          }
        }
        img.src = `https://i.ytimg.com/vi/${thumbId}/hqdefault.jpg`;
        img.alt = it.title || 'Video';
        fig.dataset.kind = 'youtube';
        fig.dataset.src  = raw;
      } else if (isCloudinary(raw)){
        const info = parseCloudinary(raw);
        fig.dataset.kind = 'video';
        fig.dataset.src  = info.src;
        if (info.poster) fig.dataset.poster = info.poster;
        img.src = info.thumb || info.poster || '';
        img.alt = it.title || 'Video';
      } else {
        // generic video
        fig.dataset.kind = 'video';
        fig.dataset.src  = raw;
        img.alt = it.title || 'Video';
      }
    } else {
      // image
      if (isCloudinary(raw)){
        const info = parseCloudinary(raw);
        fig.dataset.kind = 'image';
        fig.dataset.src  = info.src;
        img.src = info.thumb || info.src;
      } else {
        fig.dataset.kind = 'image';
        fig.dataset.src  = raw;
        img.src = raw;
      }
      img.alt = it.title || 'Foto';
    }

    const cap = document.createElement('figcaption');
    cap.className = 'cap';
    cap.textContent = it.title || '';

    fig.appendChild(img);
    fig.appendChild(cap);
    return fig;
  }

  // ===== Loader =====
  async function loadGallery(){
    try{
      const res = await fetch('gallery-data.json', { cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data  = await res.json();
      const items = Array.isArray(data) ? data : (data.items || []);

      const grid = document.getElementById('gal');
      grid.innerHTML = '';
      items.forEach(it => grid.appendChild(buildItemFromSource(it)));
      apply();
    }catch(e){
      console.error('Gagal memuat gallery-data.json', e);
    }
  }
  loadGallery();
  </script>
</body>
</html>
